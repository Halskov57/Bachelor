(opret bruger)
sequenceDiagram
    actor Bruger
    participant Frontend
    participant Backend
    participant Database

    Bruger->>Frontend: Udfylder oprettelsesformular
    Bruger->>Frontend: Klikker 'Opret Bruger'

    activate Frontend
    Frontend->>Backend: createUserRequest(userData)
    activate Backend

    Backend->>Database: insertUser(userData)
    activate Database
    Database-->>Backend: returnSuccess(newUser.id)
    deactivate Database

    Backend-->>Frontend: creationSuccess("Bruger oprettet!")
    activate Frontend
    Frontend-->>Bruger: Viser success-side / sender til login
    deactivate Frontend
    deactivate Backend




(login)
    sequenceDiagram
    actor Bruger
    participant Frontend
    participant Backend
    participant Database

    Bruger->>Frontend: Indtaster brugernavn & password
    Bruger->>Frontend: Klikker 'Log Ind'

    activate Frontend
    Frontend->>Backend: sendLoginRequest(brugernavn, password)
    activate Backend

    Backend->>Database: findUser(brugernavn, hashedPassword)
    activate Database
    Database-->>Backend: returnUser(userData)
    deactivate Database

    alt Hvis bruger findes (login succes)
        Backend->>Database: getProjectsForUser(user.id)
        activate Database
        Database-->>Backend: returnProjects(projektListe)
        deactivate Database

        Backend-->>Frontend: loginSuccess(projektListe)
        activate Frontend
        Frontend-->>Bruger: Viser projektside
        deactivate Frontend

    else Hvis bruger ikke findes (login fejl)
        Backend-->>Frontend: loginFailure("Forkert bruger/pass")
        activate Frontend
        Frontend-->>Bruger: Viser fejlmeddelelse
        deactivate Frontend
    end

    deactivate Backend


(redigere projekt)
sequenceDiagram
    actor Bruger
    participant Frontend
    participant Backend
    participant Database

    Bruger->>Frontend: Vælger et projekt fra listen
    activate Frontend
    Frontend->>Backend: getProjectDetails(projectId)
    activate Backend
    Backend->>Database: fetchProjectData(projectId)
    activate Database
    Database-->>Backend: returnProjectData(data)
    deactivate Database
    Backend-->>Frontend: displayProjectDetails(data)
    deactivate Backend
    Frontend-->>Bruger: Viser projektdetaljer/redigeringsside
    deactivate Frontend

    alt Rediger data i projekt
        Bruger->>Frontend: Ændrer data (f.eks. opgave, indstilling)
        activate Frontend
        Frontend->>Backend: updateProjectData(projectId, updatedData)
        activate Backend
        Backend->>Database: saveProjectData(projectId, updatedData)
        activate Database
        Database-->>Backend: returnSuccess()
        deactivate Database
        Backend-->>Frontend: updateSuccess("Data opdateret!")
        deactivate Backend
        Frontend-->>Bruger: Bekræfter opdatering
        deactivate Frontend
    
    else Slet data fra projekt
        Bruger->>Frontend: Vælger at slette et element
        activate Frontend
        Frontend->>Backend: deleteProjectItem(projectId, itemId)
        activate Backend
        Backend->>Database: removeProjectItem(projectId, itemId)
        activate Database
        Database-->>Backend: returnSuccess()
        deactivate Database
        Backend-->>Frontend: deleteSuccess("Element slettet!")
        deactivate Backend
        Frontend-->>Bruger: Bekræfter sletning
        deactivate Frontend
    end





    (JWT Sekvens diagram)
    ---
config:
  look: classic
---
sequenceDiagram
    actor Bruger
    participant Frontend
    participant JwtAuthFilter as JWT Auth Filter
    participant Backend
    participant JwtUtil as JWT Utility
    participant Database

    Note over Bruger, Database: JWT Authentication Flow

    Bruger->>Frontend: Indtaster login credentials
    activate Frontend
    Frontend->>Backend: POST /login (username, password)
    activate Backend
    Backend->>Database: validateUser(username, password)
    activate Database
    Database-->>Backend: returnUserData(user)
    deactivate Database

    alt Hvis credentials er gyldige
        Backend->>JwtUtil: generateToken(user)
        activate JwtUtil
        JwtUtil-->>Backend: returnJwtToken(token)
        deactivate JwtUtil
        Backend-->>Frontend: loginSuccess(jwtToken, userInfo)
        Frontend->>Frontend: storeToken(localStorage/sessionStorage)
        Frontend-->>Bruger: Redirect til hovedside
    else Hvis credentials er ugyldige
        Backend-->>Frontend: loginError("Invalid credentials")
        Frontend-->>Bruger: Vis fejlmeddelelse
    end
    deactivate Backend
    deactivate Frontend

    Note over Bruger, Database: Authenticated Request Flow

    Bruger->>Frontend: Anmoder om beskyttet ressource
    activate Frontend
    Frontend->>JwtAuthFilter: HTTP Request med Authorization header
    activate JwtAuthFilter
    JwtAuthFilter->>JwtUtil: validateToken(token)
    activate JwtUtil
    JwtUtil->>JwtUtil: checkExpiration & signature
    alt Token er gyldig
        JwtUtil-->>JwtAuthFilter: tokenValid(userInfo)
        JwtAuthFilter->>Backend: forwardRequest(authenticatedUser)
        activate Backend
        Backend->>Database: processRequest(data)
        activate Database
        Database-->>Backend: returnData(result)
        deactivate Database
        Backend-->>JwtAuthFilter: response(data)
        deactivate Backend
        JwtAuthFilter-->>Frontend: authorizedResponse(data)
        Frontend-->>Bruger: Vis data
    else Token er ugyldig/udløbet
        JwtUtil-->>JwtAuthFilter: tokenInvalid("Token expired/invalid")
        JwtAuthFilter-->>Frontend: 401 Unauthorized
        Frontend->>Frontend: clearStoredToken()
        Frontend-->>Bruger: Redirect til login
    end
    deactivate JwtAuthFilter
    deactivate JwtUtil
    deactivate Frontend


    (GraphQL Mutation sekvensdiagram)
    sequenceDiagram
    actor User
    participant ReactComponent
    participant ApolloClient
    participant apolloClientSetup
    participant JwtAuthenticationFilter
    participant ProjectResolver
    participant ProjectService
    participant ProjectRepository
    participant SSEService

    User->>ReactComponent: Updates task title
    activate ReactComponent
    
    ReactComponent->>ApolloClient: mutate(UPDATE_TASK_TITLE_MUTATION)
    activate ApolloClient
    
    ApolloClient->>apolloClientSetup: authLink.request()
    activate apolloClientSetup
    apolloClientSetup->>apolloClientSetup: localStorage.getItem('token')
    apolloClientSetup->>apolloClientSetup: setContext(Authorization header)
    apolloClientSetup-->>ApolloClient: Forward with JWT
    deactivate apolloClientSetup
    
    ApolloClient->>JwtAuthenticationFilter: POST /graphql
    activate JwtAuthenticationFilter
    
    JwtAuthenticationFilter->>JwtAuthenticationFilter: doFilterInternal()
    JwtAuthenticationFilter->>JwtAuthenticationFilter: jwtUtil.validateToken(token)
    JwtAuthenticationFilter->>JwtAuthenticationFilter: SecurityContextHolder.setAuthentication()
    
    JwtAuthenticationFilter->>ProjectResolver: updateTaskTitle()
    activate ProjectResolver
    
    ProjectResolver->>ProjectResolver: getCurrentUsername()
    ProjectResolver->>ProjectService: verifyProjectAccess()
    activate ProjectService
    
    ProjectService->>ProjectRepository: findById(projectId)
    activate ProjectRepository
    ProjectRepository-->>ProjectService: Optional<Project>
    deactivate ProjectRepository
    
    ProjectService->>ProjectService: project.getUsers().contains(username)
    ProjectService-->>ProjectResolver: Access verified
    
    ProjectResolver->>ProjectService: getTaskById()
    ProjectService->>ProjectRepository: findById(projectId)
    activate ProjectRepository
    ProjectRepository-->>ProjectService: Project with task
    deactivate ProjectRepository
    
    ProjectService-->>ProjectResolver: Task
    ProjectResolver->>ProjectResolver: task.setTitle(newTitle)
    ProjectResolver->>ProjectService: saveTask()
    
    ProjectService->>ProjectRepository: save(project)
    activate ProjectRepository
    ProjectRepository-->>ProjectService: Saved project
    deactivate ProjectRepository
    
    ProjectService-->>ProjectResolver: Updated task
    deactivate ProjectService
    
    ProjectResolver->>SSEService: sendTaskUpdate()
    activate SSEService
    SSEService->>SSEService: emitters.get(projectId).send()
    deactivate SSEService
    
    ProjectResolver-->>JwtAuthenticationFilter: Return task
    deactivate ProjectResolver
    
    JwtAuthenticationFilter-->>ApolloClient: 200 OK
    deactivate JwtAuthenticationFilter
    
    ApolloClient->>ApolloClient: cache.writeQuery()
    ApolloClient-->>ReactComponent: Success
    deactivate ApolloClient
    
    ReactComponent-->>User: UI updates
    deactivate ReactComponent


    (SSE connection)
    sequenceDiagram
    actor User
    participant ReactComponent
    participant sseService
    participant EventSource
    participant SSEController
    participant SSEService
    participant emitters

    User->>ReactComponent: Opens project page
    activate ReactComponent
    
    ReactComponent->>sseService: subscribe(projectId, callbacks)
    activate sseService
    
    sseService->>sseService: Check if connection exists
    
    alt No existing connection
        sseService->>EventSource: new EventSource(/api/sse/project/{projectId})
        activate EventSource
        
        EventSource->>SSEController: GET /api/sse/project/{projectId}
        activate SSEController
        
        SSEController->>SSEController: getCurrentUsername()
        SSEController->>SSEService: subscribe(projectId, username, emitter)
        activate SSEService
        
        SSEService->>SSEService: emitters.computeIfAbsent(projectId)
        SSEService->>emitters: Add new SseEmitter
        activate emitters
        
        SSEService->>emitters: emitter.send(connected event)
        emitters-->>EventSource: data: connected
        deactivate emitters
        
        SSEService-->>SSEController: Return emitter
        deactivate SSEService
        
        SSEController-->>EventSource: SseEmitter stream
        deactivate SSEController
        
        EventSource->>sseService: onopen event
        sseService->>sseService: Store connection
        sseService->>sseService: connectionMonitor.markConnected()
        
        EventSource->>sseService: onmessage event
        sseService->>ReactComponent: callbacks.onTaskUpdate(data)
        
        EventSource->>sseService: onerror event
        sseService->>sseService: handleReconnect()
        sseService->>sseService: connectionMonitor.markDisconnected()
        deactivate EventSource
    end
    
    sseService-->>ReactComponent: Subscription active
    deactivate sseService
    deactivate ReactComponent

    (Sekvensdiagram af REST)
    sequenceDiagram
    participant User
    participant Frontend
    participant ProjectController
    participant ProjectService
    participant ProjectRepository
    participant MongoDB

    User->>Frontend: Klikker "Create Project"
    Frontend->>Frontend: Udfylder projekt form<br/>(navn, beskrivelse)
    
    Frontend->>ProjectController: POST /projects?username={username}<br/>Body: Project JSON
    
    activate ProjectController
    ProjectController->>ProjectService: createProject(project, username)
    
    activate ProjectService
    ProjectService->>ProjectService: Validerer projekt data
    ProjectService->>ProjectRepository: save(project)
    
    activate ProjectRepository
    ProjectRepository->>MongoDB: Insert project document
    MongoDB-->>ProjectRepository: Project saved
    deactivate ProjectRepository
    
    ProjectRepository-->>ProjectService: Saved Project
    ProjectService-->>ProjectController: Project with ID
    deactivate ProjectService
    
    ProjectController-->>Frontend: 200 OK<br/>Body: Project JSON
    deactivate ProjectController
    
    Frontend->>Frontend: Opdaterer UI med nyt projekt
    Frontend-->>User: Viser succesbesked


    ---
config:
  layout: elk
---
flowchart TB editfanout
    Start(["Bruger åbner EditFanout"]) --> CheckData{"Er der data?"}
    CheckData -- Ja --> EditMode["EDIT MODE<br>- Vis eksisterende data<br>- Vis Delete button<br>- Save button"]
    CheckData -- Nej --> CreateMode["CREATE MODE<br>- Tomme felter<br>- Skjul Delete button<br>- Create button"]
    EditMode --> TypeCheck{"Hvilken type?"}
    CreateMode --> TypeCheck
    TypeCheck -- project --> ProjectUI["ProjectForm<br>+ CourseSelect<br>+ UserManagement"]
    TypeCheck -- epic --> EpicUI["BasicForm<br>Title + Description"]
    TypeCheck -- feature --> FeatureUI["BasicForm<br>Title + Description"]
    TypeCheck -- task --> TaskUI["TaskForm<br>+ StatusSelect<br>+ Due Date<br>+ UserManagement"]
    ProjectUI --> UserEdit["Bruger redigerer felter"]
    EpicUI --> UserEdit
    FeatureUI --> UserEdit
    TaskUI --> UserEdit
    UserEdit --> Submit["Klikker Save/Create"]
    Submit --> Hook["useEditFanout hook<br>- Validerer data<br>- Kalder GraphQL<br>- Opdaterer UI"]
    Hook --> Success["Success Toast<br>Lukker EditFanout"]

    style Start fill:#e1f5ff
    style CheckData fill:#fff4e1
    style EditMode fill:#e8f5e9
    style CreateMode fill:#e8f5e9
    style TypeCheck fill:#fff4e1
    style ProjectUI fill:#f3e5f5
    style EpicUI fill:#f3e5f5
    style FeatureUI fill:#f3e5f5
    style TaskUI fill:#f3e5f5
    style Success fill:#c8e6c9


graph TD editfanout
    A[EditFanout Komponent] --> B{Hvilken type?}
    B -->|type = 'project'| C[ProjectForm]
    B -->|type = 'epic'| D[BasicForm - Epic]
    B -->|type = 'feature'| E[BasicForm - Feature]
    B -->|type = 'task'| F[TaskForm]
    
    C --> C1[Vis CourseSelect]
    C --> C2[Vis UserManagement]
    C --> C3[Title + Description]
    
    D --> D1[Title + Description]
    
    E --> E1[Title + Description]
    
    F --> F1[Title + Description]
    F --> F2[StatusSelect]
    F --> F3[Due Date]
    F --> F4[UserManagement]
    
    style A fill:#e1f5ff
    style C fill:#fff4e1
    style D fill:#fff4e1
    style E fill:#fff4e1
    style F fill:#fff4e1


    måske sekvense diagram? 
    sequenceDiagram
    participant U as User
    participant F as Frontend
    participant B as Backend
    participant D as Database

    Note over U,D: User Registration
    U->>F: Fill form & click create
    F->>B: Create user request
    B->>D: Save user
    D-->>B: Success
    B-->>F: User created
    F-->>U: Show success/redirect to login

    Note over U,D: User Login
    U->>F: Enter username/password
    F->>B: Login request
    B->>D: Validate user
    alt Valid user
        D-->>B: User data
        B->>D: Get user projects
        D-->>B: Project list
        B-->>F: Login success + projects
        F-->>U: Show project page
    else Invalid user
        D-->>B: User not found
        B-->>F: Login failed
        F-->>U: Show error
    end

    Note over U,D: Edit Project
    U->>F: Select project
    F->>B: Get project details
    B->>D: Fetch project
    D-->>B: Project data
    B-->>F: Project details
    F-->>U: Show edit page
    
    alt Update data
        U->>F: Change data
        F->>B: Update request
        B->>D: Save changes
        D-->>B: Success
        B-->>F: Update confirmed
        F-->>U: Show success
    else Delete item
        U->>F: Delete item
        F->>B: Delete request
        B->>D: Remove item
        D-->>B: Success
        B-->>F: Delete confirmed
        F-->>U: Show success
    end


    domæne model?
    graph TB
    subgraph "Frontend Layer"
        UI[React Components<br/>TypeScript]
        Apollo[Apollo Client<br/>GraphQL]
        SSE[SSE Service<br/>Real-time]
    end
    
    subgraph "API Layer"
        Nginx[Nginx<br/>Reverse Proxy]
    end
    
    subgraph "Backend Layer"
        Security[Spring Security<br/>JWT Validation]
        GraphQL[GraphQL API<br/>Queries & Mutations]
        Services[Service Layer<br/>Business Logic]
        SSEBroadcast[SSE Broadcaster<br/>Events]
    end
    
    subgraph "Data Layer"
        MongoDB[(MongoDB<br/>Document DB)]
    end
    
    %% Frontend to Backend
    UI -->|User Actions| Apollo
    Apollo -->|HTTP POST<br/>GraphQL Query/Mutation<br/>+ JWT Token| Nginx
    Nginx -->|Forward Request| Security
    
    %% Backend Processing
    Security -->|Validate & Route| GraphQL
    GraphQL -->|Execute| Services
    Services -->|CRUD Operations| MongoDB
    
    %% Response Flow
    MongoDB -->|Document Data| Services
    Services -->|Process & Return| GraphQL
    GraphQL -->|JSON Response| Security
    Security -->|HTTP Response| Nginx
    Nginx -->|Return Data| Apollo
    Apollo -->|Update State| UI
    
    %% Real-time Updates
    Services -->|Trigger Event| SSEBroadcast
    SSEBroadcast -->|Server-Sent Events<br/>Event Stream| Nginx
    Nginx -->|Forward Stream| SSE
    SSE -->|Notifications| UI
    
    %% Styling
    classDef frontend fill:#61dafb,stroke:#333,stroke-width:2px,color:#000
    classDef backend fill:#6db33f,stroke:#333,stroke-width:2px,color:#fff
    classDef database fill:#47a248,stroke:#333,stroke-width:2px,color:#fff
    classDef proxy fill:#ff9900,stroke:#333,stroke-width:2px,color:#000
    
    class UI,Apollo,SSE frontend
    class Security,GraphQL,Services,SSEBroadcast backend
    class MongoDB database
    class Nginx proxy

    Data flow?
    graph LR
    subgraph "Client"
        A[React UI]
    end
    
    subgraph "Communication"
        B[GraphQL Queries/Mutations]
        C[SSE Event Stream]
        D[JWT Token]
    end
    
    subgraph "Server"
        E[Spring Boot API]
    end
    
    subgraph "Storage"
        F[MongoDB Documents]
    end
    
    A -->|1. Request + JWT| B
    B -->|2. Validate & Process| E
    E -->|3. Read/Write| F
    F -->|4. Return Data| E
    E -->|5. GraphQL Response| B
    B -->|6. Update UI| A
    
    E -.->|7. Broadcast Events| C
    C -.->|8. Real-time Updates| A
    
    A -->|Authentication| D
    D -->|Authorization| E
    
    classDef client fill:#61dafb,stroke:#333,stroke-width:2px
    classDef comm fill:#ff9900,stroke:#333,stroke-width:2px
    classDef server fill:#6db33f,stroke:#333,stroke-width:2px
    classDef storage fill:#47a248,stroke:#333,stroke-width:2px
    
    class A client
    class B,C,D comm
    class E server
    class F storage